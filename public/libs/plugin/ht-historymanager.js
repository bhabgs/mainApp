!function(v,O,S){"use strict";var k="ht",L=v[k],W=L.Default,m=W.def,M=W.getInternal();L.HistoryManager=function(q){this._histories=[],this.setDataModel(q)},m(L.HistoryManager,O,{ms_ac:["dataModel","histories","historyIndex","maxHistoryCount","disabled"],ms_fire:1,_historyIndex:-1,_betweenTransaction:0,_maxHistoryCount:200,_disabled:!1,ignoredPropertyMap:{imageLoaded:!0,children:!0,attaches:!0,shape:!0,childChange:!0,agentChange:!0,sourceAgent:!0,targetAgent:!0,edgeGroup:!0,"*":!0},ignoreDataModelPropertyMap:{},beginInteraction:function(){this.beginTransaction()},endInteraction:function(){this.endTransaction()},beginTransaction:function(){if(!this._disabled){var a=this;a._betweenTransaction++,1===a._betweenTransaction&&(a._transactionHistories={})}},endTransaction:function(){if(!this._disabled){var B=this,b=B._histories;if(B._betweenTransaction>0&&B._betweenTransaction--,0===B._betweenTransaction){if(B._transactionHistories){var h=[];for(var j in B._transactionHistories)h.push(B._transactionHistories[j]);h.length&&(b=b.slice(0,B._historyIndex+1),b.push(h),b.length>B._maxHistoryCount&&(b=b.slice(b.length-B._maxHistoryCount)),B.setHistories(b),B.setHistoryIndex(b.length-1,!0))}delete B._transactionHistories}}},setDataModel:function(w){var o=this,V=o._dataModel;V!==w&&(V&&(delete V._historyManager,V.ump(o.handleDataModelPropertyChange,o),V.umm(o.$5p,o),V.umd(o.$6p,o),V.removeHierarchyChangeListener(o.handleHierarchyChange,o),V.removeIndexChangeListener(o.handleIndexChange,o)),o._dataModel=w,w&&(w._historyManager=o,w.mp(o.handleDataModelPropertyChange,o),w.mm(o.$5p,o),w.md(o.$6p,o),w.addHierarchyChangeListener(o.handleHierarchyChange,o),w.addIndexChangeListener(o.handleIndexChange,o)),o.fp("dataModel",V,w),o.clear())},setHistoryIndex:function(t,Y){var y=this,J=y._historyIndex,p=y._histories.length;if(-1>t?t=-1:t>=p&&(t=p-1),J!==t){if(!Y){var H=t-J;H>0?y.$2p(H):0>H&&y.$1p(-H)}y._historyIndex=t,y.fp("historyIndex",J,t),y.dataModel&&y.dataModel.onHistoryManagerChanged()}},setMaxHistoryCount:function(d){var s=this,X=s._histories,o=s._maxHistoryCount;(!d||0>=d)&&(d=10),o!==d&&(s._maxHistoryCount=d,s.fp("maxHistoryCount",o,d),X.length>d&&s.clear())},cloneValue:function(z){return L.Default.clone(z)},isPropertyUndoable:function(p){return p&&!this.ignoredPropertyMap[p]},isIndexUndoable:function(){return!1},isDataModelPropertyUndoable:function(k){return k&&!this.ignoreDataModelPropertyMap[k]},$5p:function(e){this.handleChange(e,e.kind)},$6p:function(V){this.handleChange(V,"property")},handleHierarchyChange:function(r){this.handleChange(r,"hierarchy")},handleIndexChange:function(l){this.handleChange(l,"index")},handleDataModelPropertyChange:function(N){this.handleChange(N,"dataModelProperty")},toChildrenInfo:function(U){var F={};return F.data=U,F.children=[],U.eachChild(function(s){F.children.push(this.toChildrenInfo(s))},this),F},restoreChildren:function(e){var m=e.data;e.children.forEach(function(O){var s=O.data;s.getParent()!==m&&m.addChild(s),this._dataModel.contains(s)||this._dataModel.add(s),this.restoreChildren(O)},this)},handleChange:function(u,X){var I=this;if(!(I._disabled||I._isUndoRedoing||W.loadingRefGraph)){var w,l=(I._histories,u.data),z=u.property;if(!l||!(l._refGraph||l instanceof L.RefGraph)){if("property"===X)I.isPropertyUndoable(z,l)&&(w={kind:X,data:l,property:z,oldValue:I.cloneValue(u.oldValue,l,z),newValue:I.cloneValue(u.newValue,l,z),event:u});else if("hierarchy"===X||"index"===X&&I.isIndexUndoable(u))w={kind:X,data:l,oldIndex:u.oldIndex,newIndex:u.newIndex,event:u};else if("clear"===X)w={kind:X,json:u.json,event:u};else if("add"===X){if(w={kind:X,data:l,event:u,childrenInfo:this.toChildrenInfo(l),parent:l.getParent()},w.parent){var N=I._dataModel.getSiblings(l);w.siblingsIndex=N.indexOf(l)}l instanceof L.Node&&(w.host=l.getHost(),w.attaches=l.getAttaches()?l.getAttaches().toArray():S),l instanceof L.Edge&&(w.source=l.getSource(),w.target=l.getTarget())}else"remove"===X?w={kind:X,data:l,event:u}:"dataModelProperty"===X&&I.isDataModelPropertyUndoable(z,l)&&(w={kind:X,property:z,oldValue:I.cloneValue(u.oldValue,l,z),newValue:I.cloneValue(u.newValue,l,z),event:u});I.addHistory(w)}}},addHistory:function(W){var f=this;if(W)if(f._betweenTransaction){var c=(W.data?W.data._id:0)+"_"+W.kind+"_"+W.property;if("property"===W.kind||"dataModelProperty"===W.kind){var i=f._transactionHistories[c];i&&(W.oldValue=i.oldValue)}f._transactionHistories[c]=W}else{var k=f._histories;k=k.slice(0,f._historyIndex+1),k.push([W]),k.length>f._maxHistoryCount&&(k=k.slice(k.length-f._maxHistoryCount)),f.setHistories(k),f.setHistoryIndex(k.length-1,!0)}},canUndo:function(){return!this._disabled&&this._historyIndex>=0&&this._historyIndex<this._histories.length},canRedo:function(){return!this._disabled&&this._historyIndex>=-1&&this._historyIndex<this._histories.length-1},undo:function(I){(!I||0>=I)&&(I=1),this.setHistoryIndex(this._historyIndex-I)},$1p:function(y){if(this.canUndo()){var c,x=this,l=x._dataModel,I=x._histories,K=x._historyIndex,E=0;for(x._isUndoRedoing=!0,W.setIsolating(!0);y>0;){if(K>=0&&K<I.length){E++,c=I[K],K--;for(var C=c.length-1;C>=0;C--){var U=c[C],f=U.kind,D=U.data,i=U.property,Z=U.event,e=this.cloneValue(U.oldValue,D,i);if(U.undo)U.undo();else if("add"===f)l.remove(D,{keepChildren:!0});else if("remove"===f)l.contains(D)||l.add(D,Z.rootsIndex,Z.datasIndex);else if("clear"===f)l.deserialize(W.clone(U.json));else if("property"===f)if("parent"===i)e?e.addChild(D,Z.oldIndex):(D.setParent(e),Z.oldIndex>=0&&l.moveTo(D,Z.oldIndex));else{var k=null;0===i.indexOf("a:")?(k="attr",i=i.replace("a:","")):0===i.indexOf("s:")?(k="style",i=i.replace("s:","")):0===i.indexOf("f:")&&(k="field",i=i.replace("f:","")),M.setPropertyValue(D,k,i,e)}else if("dataModelProperty"===f){var k=null;0===i.indexOf("a:")?(k="attr",i=i.replace("a:","")):0===i.indexOf("s:")?(k="style",i=i.replace("s:","")):0===i.indexOf("f:")&&(k="field",i=i.replace("f:","")),M.setPropertyValue(l,k,i,e)}else"hierarchy"===f?l.moveTo(D,U.oldIndex):"index"===f?l.moveToIndex(D,U.oldIndex):"selection"===f&&l.sm().ss(U.oldValue)}}y--}W.setIsolating(!1),delete x._isUndoRedoing,x.afterUndo(E)}},afterUndo:function(){},redo:function(a){(!a||0>=a)&&(a=1),this.setHistoryIndex(this._historyIndex+a)},$2p:function(N){if(this.canRedo()){var y,Y=this,f=Y._dataModel,a=Y._histories,F=Y._historyIndex,k=0;for(Y._isUndoRedoing=!0,W.setIsolating(!0);N>0;){if(F>=-1&&F<a.length-1){k++,F++,y=a[F];for(var $=0;$<y.length;$++){var R=y[$],q=R.kind,e=R.data,m=R.property,s=R.event,K=this.cloneValue(R.newValue,e,m);if(R.redo)R.redo();else if("add"===q)R.parent&&!e.getParent()&&R.parent.addChild(e,R.siblingsIndex),f.contains(e)||f.add(e,s.rootsIndex,s.datasIndex),this.restoreChildren(R.childrenInfo),e instanceof L.Node&&(e.setHost(R.host),R.attaches&&R.attaches.forEach(function(S){S.setHost(e)})),e instanceof L.Edge&&(e.setSource(R.source),e.setTarget(R.target));else if("remove"===q)f.remove(e);else if("clear"===q)f.clear();else if("property"===q)if("parent"===m)K?K.addChild(e,s.newIndex):(e.setParent(K),s.newIndex>=0&&f.moveTo(e,s.newIndex));else{var H=null;0===m.indexOf("a:")?(H="attr",m=m.replace("a:","")):0===m.indexOf("s:")?(H="style",m=m.replace("s:","")):0===m.indexOf("f:")&&(H="field",m=m.replace("f:","")),M.setPropertyValue(e,H,m,K)}else if("dataModelProperty"===q){var H=null;0===m.indexOf("a:")?(H="attr",m=m.replace("a:","")):0===m.indexOf("s:")?(H="style",m=m.replace("s:","")):0===m.indexOf("f:")&&(H="field",m=m.replace("f:","")),M.setPropertyValue(f,H,m,K)}else"hierarchy"===q?f.moveTo(e,R.newIndex):"index"===q?f.moveToIndex(e,R.newIndex):"selection"===q&&f.sm().ss(R.newValue)}}N--}W.setIsolating(!1),delete Y._isUndoRedoing,this.afterRedo(k)}},afterRedo:function(){},clear:function(){this.setHistories([]),this.setHistoryIndex(-1,!0),this._betweenTransaction=0,delete this._transactionHistories}})}("undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:(0,eval)("this"),Object);